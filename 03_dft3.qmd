---
title: "Round 3"
---

> ***TODO:** check with latest version of demo*


Once the round 3 is finished in REDCap, you can open `0_run_ME_dft3.R`. It will show you the order of files to update and run.

## Update data {#sec-update-data-round3}

-   [ ] run `./code/dft3/01a_dft3_update_data_with_REDCapR.R`

This code will connect to the corresponding REDCap project using the token, and downloads the raw data and metadata from the project and save them as RData. It also creates xlsx tables by variable type with the raw data, which can be used for quick checks.

| Folder                    | Output file                   | Description                                    |
|--------------------|-----------------------|-----------------------------|
| `./data/redcap_data_raw/` | `dft3_metadata.RData`         | Raw metadata                                   |
| `./data/redcap_data_raw/` | `dft3_data_redcapr_raw.RData` | Raw data                                       |
| `./output/check/`         | `chk_dft3_type1_raw.xlsx`     | Check table with raw data for type 1 questions |

:::{.callout-note appearance=minimal}
There should be only type 1 questions in this round. The code is therefore simpler and run faster than in round 2.
:::

## Recode data {#sec-recode-data-round3}

-   [ ] update and run `./code/dft3/01b_dft3_recode_data.R`

This code will process the data and the metadata in order to create the "clean" data and metadata tables. In particular, it will:

\- correct labelling errors, typos, etc.

\- simplify labelling

\- define the lists of variables by type (1)

\- do a conditional deduplication (in case participants have filled in several REDCap records for the same participant -\> keep the latest answer choice but all comments)

\- save clean data and metadata in RData format

::: column-margin
![dft3_z_s4_type1.png (for the statement 4 in preamble of round 3)](_img/dft3_z_s4_type1.png){#fig-dft3-type1 fig-align="center"}
:::

\- create visuals (.png) for all type 1 questions, showing the distribution of answers on a 1 to 9 scale and a boxplot - see @fig-dft3-type1

### Detail of outputs

| Folder         | Output file                            | Description       |
|--------------------|-----------------------|-----------------------------|
| `./data/dft3/` | `dft3_data_clean.RData`                | Clean data        |
| `./data/dft3/` | `dft3_lookup_final.RData` | Clean lookup table (metadata) |

## Prepare tables without participant id {#sec-prepare-tables-without-participant-id-round3}

`02a_dft3_prepare_tables_without_participant_id.R`

This code will analyse the "clean" data (generated in #sec-recode-data-round3) to create the group results tables (= statistical summaries and graphs). 

It automatically calls code `01c_dft3_define_cols.R.` 

It also creates and saves in xlsx format tables containing only the "no opinion" responses, allowing a quick check.

### Detail of outputs

| Folder            | Output file                      | Description                                     |
|----------------------|-------------------------|-------------------------|
| `./output/RData/` | `dft3_type0_zz1.RData`           | Table with characteristics of participants      |
| `./output/RData/` | `dft3_dt_comments_m.RData`       | Table with results of all comments              |
| `./output/check/` | `dft3_type1_zz0_no_opinion.xlsx` | Check tables of no opinion for type 1 questions |
| `./output/check/` | `dft3_type3_zz0_no_opinion.xlsx` | Check tables of no opinion for type 3 questions |

## Update texts for introduction {#sec-update-texts-introduction-round3}

-   [ ] Update the texts (\*.docx) if needed as indicated in the [Start your project](#sec-update-texts-introduction) section.

-   [ ] run `00_update_texts_intro.R`

This code updates the local directory of texts used in the introduction of the reports (from the available and up-to-date directory on the server).

## Publish the generic report {#sec-create-generic-report-round3}

-   [ ] update in `./.analysis/dft3/` the following files so it corresponds to your project:

    -   `dft3_report_generic.Rmd`

    -   `dft3_child_section_Z.Rmd` \[Preamble\]

    -   `dft3_child_section_A.Rmd`

    -   `dft3_child_section_B.Rmd`

    -   `dft3_child_section_C.Rmd`

-   [ ] publish the generic report by running the lines below in `0_run_ME_dft3.R`

    ``` r
    ### . publish Rmd ----
    ### .. dft3_report_generic.Rmd ----
    input <-  "analysis/dft3/dft3_report_generic.Rmd"

    output_file <- here::here('output', 'reports', 'dft3',
                              stringr::str_glue("dft3_report_generic_{Sys.Date()}.docx"))

    rmarkdown::render(
      input = input,
      output_file = output_file)
    ```

This code will create the word document ("generic report") inserting the texts for introduction (updated in @sec-update-texts-introduction-round3) and the results tables (created in @sec-prepare-tables-without-participant-id-round3), based on a reference word template.

It automatically calls `01c_dft3_define_cols.R.`

It will then call one .Rmd per section, which themselves will call one code:

-   `./code/03a_create_flextable_results_type_1_generic.R` : creates the results table for type 1 statements in the section and for their comments


### Detail of outputs

| Folder             | Output file              | Description |
|--------------------|-----------------------|-----------------------------|
| `./output/reports/dft3`|`dft3_report_generic_date_YYYY-MM-DD.docx` | Generic report with date |



## Update introductory texts with round results from 2

-   [ ] update the introductory texts on the server with some elelements from the generic report created in @sec-create-generic-report-round3

-   [ ] update image with the results : ppt \


> ***TODO* : detail which slide and what to update and save as...*

-   [ ] run `00_update_texts_intro.R` one more time


## Run generic report again

-   [ ] run the generic report one more time to insert the updated introductory texts  

## Create individual report {#sec-create-individual-report-round3}

-   [ ] update `./.analysis/dft3/dft3_report_per_participant.Rmd`

-   [ ] publish individual reports by running the lines below in `0_run_ME_dft3.R`

    ``` r

    ### .. 05_dft3_to_render_individual_reports.R ------------------------------
    ### TAKES time ... have a coffee, a walk, a nice chat with someone ...
    source(here::here('code', 'dft3', '05_dft3_to_render_individual_reports.R'),
           encoding = 'UTF-8')
    ```

This code will create the word document for each participant ("participant report") by inserting the email of the participant, the texts for introduction (updated in @sec-update-texts-introduction-round3), the results tables with the individual answers, based on a word template.

It will iteratively publish `.analysis/dft3/dft3_report_per_participant.Rmd` for each participants by calling automatically :

- `./code/dft3/01c_dft3_define_cols.R` and

- `./code/dft3/02b_dft3_prepare_tables_participants.R` : add results of the participant to generic table

It will then call one .Rmd per section, which themselves call one codes:

-   `./code/03a_create_flextable_results_type_1_participants.R` : creates the results table for type 1 statements with individual answers in the section and for their comments


### Detail of outputs

| Folder             | Output file              | Description |
|--------------------|-----------------------|-----------------------------|
| `/output/reports/dft3/report_by_participant/`|`dft3_report_participant_X_YYYY-MM-DD.docx` | Participant report with date |
